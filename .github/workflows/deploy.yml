name: Deploy to VPS
on:
  push:
    branches:
      - main
    
    
  workflow_dispatch:
    # ğŸ–±ï¸ Permet dÃ©clenchement manuel depuis l'UI GitHub
    # Utile pour : redÃ©ploiement aprÃ¨s incident, rollback, tests
    # Accessible : onglet Actions â†’ Select workflow â†’ Run workflow

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ’¼ JOB DE DÃ‰PLOIEMENT
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  deploy:
    runs-on: ubuntu-latest
    # ğŸ–¥ï¸ Runner GitHub-hosted (machine virtuelle Ubuntu)
    # Alternatives : self-hosted runner (sur le VPS lui-mÃªme, Ã©conomise SSH)
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ã‰TAPE 1 : RÃ©cupÃ©ration du code
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        # ğŸ“¦ Action officielle GitHub : clone le repo dans le runner
        # Ã‰quivalent Ã  : git clone https://github.com/{owner}/{repo}.git
        # @v4 : version de l'action (pinning pour stabilitÃ©)
        #
        # ğŸ’¡ POURQUOI CHECKOUT ?
        # MÃªme si on re-clone sur le VPS, utile pour :
        # - Futurs steps de tests (pytest, linting)
        # - Build d'images Docker en local avant push registry
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ã‰TAPE 2 : Configuration SSH
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          # ğŸ“ CrÃ©e rÃ©pertoire SSH (non existant par dÃ©faut sur runner)
          
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          # ğŸ”‘ Ã‰crit la clÃ© privÃ©e depuis GitHub Secrets
          # Format attendu : clÃ© ED25519 (plus sÃ©curisÃ©e que RSA)
          # GÃ©nÃ©ration : ssh-keygen -t ed25519 -C "github-actions"
          
          chmod 600 ~/.ssh/id_ed25519
          # ğŸ”’ Permissions strictes (lecture seule pour owner)
          # SSH refuse de fonctionner si permissions trop permissives
          
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          # ğŸ›¡ï¸ Ajoute la clÃ© publique du serveur (Ã©vite prompt "Are you sure?")
          # -H : hash du hostname (sÃ©curitÃ© supplÃ©mentaire)
          # Alternative : ajouter manuellement la fingerprint du serveur
      - name: ğŸ“¦ Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          STUDENT_ID: ${{ secrets.STUDENT_ID }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ssh $VPS_USER@$VPS_HOST bash << 'ENDSSH'
            set -e
            
            # Variables
            STUDENT_ID="${{ secrets.STUDENT_ID }}"
            REPO_NAME="${{ github.event.repository.name }}"
            PROJECT_DIR="$HOME/apps/${REPO_NAME}-${STUDENT_ID}"
            
            echo "ğŸ“ Dossier: $PROJECT_DIR"
            
            # Clone/Update
            if [ -d "$PROJECT_DIR" ]; then
              cd "$PROJECT_DIR"
              git pull
            else
              cd $HOME/apps
              git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${REPO_NAME}-${STUDENT_ID}
              cd ${REPO_NAME}-${STUDENT_ID}
            fi
            
            # Copier le .env
            echo "ğŸ“„ Copie du fichier .env..."
            cp $HOME/apps/.env.${STUDENT_ID} .env
            #cp $HOME/apps/.env.${STUDENT_ID} docker/.env
            
            # DÃ©ployer
            echo "ğŸ³ DÃ©ploiement Docker..."
            #cd docker
            
            # ArrÃªter les containers existants
            docker compose -p cv-${STUDENT_ID} down 2>/dev/null || true
            
            # Build
            echo "ğŸ”¨ Build des images..."
            docker compose -p cv-${STUDENT_ID} -f docker/docker-compose.yml build --no-cache
            
            # Up
            echo "ğŸš€ DÃ©marrage des containers..."
            docker compose -p cv-${STUDENT_ID} -f docker/docker-compose.yml up -d
            
            # Attendre que les services dÃ©marrent
            echo "â³ Attente du dÃ©marrage..."
            sleep 10
            
            # VÃ©rifier l'Ã©tat
            echo "âœ… Ã‰tat des containers:"
            docker compose -p cv-${STUDENT_ID} ps
            
            # Cleanup
            echo "ğŸ§¹ Nettoyage..."
            docker image prune -af --filter "until=24h"
            
            echo "âœ… DÃ©ploiement terminÃ© pour ${STUDENT_ID}"
          ENDSSH

      - name: âœ… Deployment Success
        run: |
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi pour ${{ secrets.STUDENT_ID }}"
          echo "ğŸ“Š Grafana: http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_GRAFANA }}"
          echo "ğŸ”§ API: http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_API }}"
          echo "ğŸ“ˆ Prometheus: http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_PROMETHEUS }}"
          echo ""
          echo "ğŸ§ª Test de santÃ©:"
          curl -f http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_API }}/health || echo "âš ï¸  API pas encore prÃªte"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ AMÃ‰LIORATIONS POSSIBLES (pour aller plus loin)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. TESTS AVANT DÃ‰PLOIEMENT
#    - name: ğŸ§ª Run tests
#      run: |
#        pip install -r requirements/dev.txt
#        pytest tests/ -v
#    â†’ Ã‰vite dÃ©ploiement si tests Ã©chouent
#
# 2. SMOKE TESTS POST-DÃ‰PLOIEMENT
#    - name: ğŸ”¥ Health check
#      run: |
#        curl -f http://${{ secrets.VPS_HOST }}:8000/health || exit 1
#    â†’ VÃ©rifie que l'API rÃ©pond (rollback auto si Ã©chec)
#
# 3. NOTIFICATIONS (Discord, Slack)
#    - name: ğŸ“¢ Notify deployment
#      if: success()
#      run: |
#        curl -X POST ${{ secrets.DISCORD_WEBHOOK }} \
#          -H "Content-Type: application/json" \
#          -d '{"content":"âœ… DÃ©ploiement V3 rÃ©ussi !"}'
#
# 4. ROLLBACK AUTOMATIQUE
#    - Sauvegarder hash du commit avant pull
#    - Si healthcheck Ã©choue â†’ git reset --hard $PREVIOUS_HASH
#
# 5. STAGING ENVIRONMENT
#    - DÃ©ployer d'abord sur staging (branches develop)
#    - Validation manuelle â†’ merge main â†’ dÃ©ploiement prod
#
# 6. DOCKER REGISTRY (optimisation)
#    - Build image en CI â†’ push vers DockerHub/GHCR
#    - VPS pull image (pas de rebuild sur serveur)
#    â†’ DÃ©ploiement 10x plus rapide
#
# 7. SECRETS ROTATION
#    - Automatiser rotation des credentials (DB, API tokens)
#    - Utiliser HashiCorp Vault ou AWS Secrets Manager
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› ï¸ SETUP INITIAL DU VPS (Ã  faire manuellement UNE FOIS)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. INSTALLATION DOCKER
#    curl -fsSL https://get.docker.com | sh
#    sudo usermod -aG docker $USER
#
# 2. CRÃ‰ATION STRUCTURE
#    mkdir -p ~/apps
#    cd ~/apps
#    nano .env  # Remplir avec secrets production
#
# 3. CONFIGURATION SSH
#    # Sur VPS
#    ssh-keygen -t ed25519
#    cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys
#    
#    # Copier ~/.ssh/id_ed25519 dans GitHub Secrets (SSH_PRIVATE_KEY)
#
# 4. FIREWALL (ufw)
#    sudo ufw allow 22    # SSH
#    sudo ufw allow 8000  # FastAPI
#    sudo ufw allow 3000  # Grafana
#    sudo ufw allow 9090  # Prometheus
#    sudo ufw enable
#
# 5. REVERSE PROXY (optionnel, recommandÃ©)
#    # Nginx avec SSL (Let's Encrypt)
#    # api.mondomaine.com â†’ localhost:8000
#    # grafana.mondomaine.com â†’ localhost:3000
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“š RESSOURCES PÃ‰DAGOGIQUES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# - GitHub Actions docs: https://docs.github.com/en/actions
# - Docker Compose in prod: https://docs.docker.com/compose/production/
# - SSH best practices: https://www.ssh.com/academy/ssh/key
# - CI/CD patterns: https://www.martinfowler.com/articles/continuousIntegration.html
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•