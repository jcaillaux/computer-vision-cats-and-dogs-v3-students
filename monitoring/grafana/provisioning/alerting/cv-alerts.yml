apiVersion: 1

groups:
  - orgId: 1
    name: cv-monitoring
    folder: Computer Vision
    interval: 1m
    
    rules:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”´ ALERTE 1 : Base de donnÃ©es dÃ©connectÃ©e (CRITICAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-db-disconnected
        title: Database Disconnected
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: cv_database_connected
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          description: L'API ne peut plus accÃ©der Ã  PostgreSQL
          summary: Base de donnÃ©es PostgreSQL dÃ©connectÃ©e
        labels:
          severity: critical
        isPaused: false

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš ï¸ ALERTE 2 : Latence d'infÃ©rence Ã©levÃ©e (WARNING)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-high-latency
        title: High Inference Latency
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: rate(cv_inference_time_seconds_sum[5m]) / rate(cv_inference_time_seconds_count[5m])
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2
                    type: gt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: OK
        execErrState: Error
        for: 10m
        annotations:
          description: "La latence moyenne d'infÃ©rence dÃ©passe 2 secondes depuis 2 minutes. VÃ©rifier charge CPU/GPU et modÃ¨le."
          summary: "Latence d'infÃ©rence Ã©levÃ©e (> 2s)"
        labels:
          severity: warning
          component: inference
        isPaused: false
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš ï¸ ALERTE 3 : Feedback nÃ©gatifs (WARNING)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-high-negative-feedback
        title: High Negative Feedback Rate
        condition: C
        intervalSeconds: 30
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(cv_user_feedback_total{feedback="0"}[10m])) / sum(rate(cv_user_feedback_total[10m]))
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.5  # 50%
                    type: gt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: OK
        execErrState: Alerting  # Alerte si pas de donnÃ©es (peut indiquer un problÃ¨me)
        for: 30m  # Pendant 30 minutes
        annotations:
          description: "Le taux de feedback nÃ©gatif dÃ©passe 50% depuis 10 minutes. VÃ©rifier la qualitÃ© des infÃ©rences et l'expÃ©rience utilisateur."
          summary: "Taux Ã©levÃ© de feedbacks nÃ©gatifs (> 50%)"
        labels:
          severity: critical  # Plus grave que warning
          component: feedback
        isPaused: false
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš ï¸ ALERTE 4 : Confiance des prÃ©diction trop basse (WARNING)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-low-prediction-confidence
        title: Low Prediction Confidence Rate
        condition: C
        intervalSeconds: 30
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(cv_prediction_confidence_bucket{le="60.0"}[1h]))/sum(rate(cv_prediction_confidence_count[1h]))
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.8  # 80%
                    type: gt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: OK
        execErrState: Alerting  # Alerte si pas de donnÃ©es (peut indiquer un problÃ¨me)
        for: 10m  # Pendant 10 minutes
        annotations:
          description: "Le taux de prÃ©diction avec une confiance infÃ©rieure Ã  60% depuis 10 minutes. VÃ©rifier la qualitÃ© des infÃ©rences et l'expÃ©rience utilisateur."
          summary: "Taux prÃ©dictions avec une confiance < 60% trop Ã©levÃ©."
        labels:
          severity: warning  # Plus grave que warning
          component: feedback
        isPaused: false
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš ï¸ ALERTE 5 : Taux de requÃªtes top Ã©levÃ© (CRITICAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-too-many-requests
        title: Too many requests
        condition: C
        intervalSeconds: 30
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(increase(http_requests_total{handler!~"/metrics|/health|none"}[1h]))
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 10000  # 50%
                    type: gt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: OK
        execErrState: Alerting  # Alerte si pas de donnÃ©es (peut indiquer un problÃ¨me)
        for: 1m  # Pendant 10 minutes
        annotations:
          description: "Le nombre de requÃªtes par heure est trop Ã©levÃ©. VÃ©rifier les logs systÃ¨mes."
          summary: "Le service reÃ§oit plus de 10 000 requÃªtes par heure."
        labels:
          severity: critical  # Plus grave que warning
          component: feedback
        isPaused: false
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš ï¸ ALERTE 6 : ModÃ¨le potentiellement biaisÃ© (CRITICAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-biased-model-detected
        title: La rÃ©partition des cibles prÃ©dites est biasÃ©e
        condition: C
        intervalSeconds: 30
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum by (target) (increase(cv_predicted_target_total[1h])) / scalar(sum(increase(cv_predicted_target_total[1h])))
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.8  # 80%
                    type: gt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: OK
        execErrState: Alerting  # Alerte si pas de donnÃ©es (peut indiquer un problÃ¨me)
        for: 10m  # Pendant 10 minutes
        annotations:
          description: "Le taux de la cible majoritaire dÃ©passe 80%. VÃ©rifier un potentiel biais du modÃ¨le."
          summary: "Le service prÃ©dit une seule classe majoritairement (> 80%)."
        labels:
          severity: critical  # Plus grave que warning
          component: feedback
        isPaused: false